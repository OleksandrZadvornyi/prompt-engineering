<html>
  <head>
    <meta charset="utf-8" />
    <title>LLM Code Generation Report #{{ request_number }}</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        line-height: 1.6;
        color: #333;
        margin: 20px auto;
        padding: 20px;
        background-color: #f9f9f9;
      }
      .container {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1,
      h2 {
        color: #2c3e50;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 8px;
        margin-bottom: 16px;
      }
      h1 {
        font-size: 24px;
      }
      h2 {
        font-size: 20px;
      }
      .header-info p {
        margin: 8px 0;
        font-size: 14px;
      }
      pre {
        background-color: #f4f4f4;
        padding: 12px;
        border-radius: 4px;
        font-size: 13px;
        overflow-x: auto;
      }
      .metrics table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }
      .metrics th,
      .metrics td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
        font-size: 14px;
      }
      .metrics th {
        background-color: #f0f0f0;
        font-weight: bold;
      }
      .nested-table table {
        width: 100%;
        margin: 10px 0;
      }
      .nested-table td {
        padding: 8px;
        font-size: 13px;
      }
      .runtime-output pre {
        white-space: pre-wrap; /* Since CSS 2.1 */
        white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        word-wrap: break-word; /* Internet Explorer 5.5+ */
      }
      .visualizations img {
        max-width: 100%;
        margin: 10px 0;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>LLM Code Generation Report #{{ request_number }}</h1>

      <div class="header-info">
        <p><b>Timestamp:</b> {{ timestamp }}</p>
        <p><b>Model:</b> {{ model }}</p>
        <p><b>Logprobs available:</b> {{ supports_logprobs }}</p>
      </div>

      <h2>Selected User Stories</h2>
      <pre>{{ stories_text }}</pre>

      <h2>Prompt Sent to LLM</h2>
      <pre>{{ prompt }}</pre>

      <h2>Generated Code</h2>
      <pre>{{ code }}</pre>

      <h2>Confidence & Basic Metrics</h2>
      <div class="metrics">
        <table>
          <tr>
            <th>Total tokens</th>
            <td>{{ total_tokens }}</td>
          </tr>
          <tr>
            <th>Total log-probability</th>
            <td>{{ "%.3f"|format(total_logprob) }}</td>
          </tr>
          <tr>
            <th>Average per-token probability</th>
            <td>{{ "%.2f%%"|format(avg_prob * 100) }}</td>
          </tr>
          <tr>
            <th>Perplexity</th>
            <td>{{ "%.2f"|format(perplexity) }}</td>
          </tr>
        </table>
      </div>

      <h2>Code Structure & Length Metrics</h2>
      <div class="metrics">
        <table>
          <tr>
            <th>Function count (AST)</th>
            <td>{{ struct_metrics["function_count"] }}</td>
          </tr>
          <tr>
            <th>Class count (AST)</th>
            <td>{{ struct_metrics["class_count"] }}</td>
          </tr>
          <tr>
            <th>Number of lines</th>
            <td>{{ struct_metrics["num_lines"] }}</td>
          </tr>
          <tr>
            <th>Non-empty lines</th>
            <td>{{ struct_metrics["num_nonempty_lines"] }}</td>
          </tr>
          <tr>
            <th>Avg line length (all lines, chars)</th>
            <td>
              {{ "%.1f"|format(struct_metrics["avg_line_len_all_chars"]) }}
            </td>
          </tr>
          <tr>
            <th>Avg line length (non-empty, chars)</th>
            <td>
              {{ "%.1f"|format(struct_metrics["avg_line_len_nonempty_chars"]) }}
            </td>
          </tr>
          <tr>
            <th>Avg tokens per non-empty line</th>
            <td>
              {{ "%.2f"|format(struct_metrics["avg_tokens_per_nonempty_line"])
              }}
            </td>
          </tr>
          <tr>
            <th>AST depth (max nesting)</th>
            <td>{{ struct_metrics["ast_depth"] }}</td>
          </tr>
          <tr>
            <th>Import count</th>
            <td>{{ struct_metrics["import_count"] }}</td>
          </tr>
          <tr>
            <th>Import names</th>
            <td>{{ ", ".join(struct_metrics["import_names"]) }}</td>
          </tr>
          <tr>
            <th>Avg cyclomatic complexity (functions)</th>
            <td>
              {{ "%.2f"|format(struct_metrics["avg_cyclomatic_complexity"]) }}
            </td>
          </tr>
          <tr>
            <th>Max cyclomatic complexity (functions)</th>
            <td>{{ struct_metrics["max_cyclomatic_complexity"] }}</td>
          </tr>
          <tr>
            <th>Module cyclomatic complexity</th>
            <td>{{ struct_metrics["module_cyclomatic_complexity"] }}</td>
          </tr>
          <tr>
            <th>Average function size (lines)</th>
            <td>
              {{ "%.1f"|format(struct_metrics["avg_function_size_lines"]) }}
            </td>
          </tr>
          <tr>
            <th>Comment density (%)</th>
            <td>
              {{ "%.1f"|format(struct_metrics["comment_density_percent"]) }}%
            </td>
          </tr>
          <tr>
            <th>Import redundancy ratio</th>
            <td>
              {{ "%.2f"|format(struct_metrics["import_redundancy_ratio"]) }}
            </td>
          </tr>
        </table>
      </div>

      <h2>Semantic Quality Metrics</h2>
      <div class="metrics">
        <table>
          <tr>
            <th>Syntax valid</th>
            <td>{{ semantic_metrics["syntax_valid"] }}</td>
          </tr>
          <tr>
            <th>Flake8 style errors</th>
            <td>{{ semantic_metrics["flake8_error_count"] }}</td>
          </tr>
          <tr>
            <th>Flake8 errors (by category)</th>
            <td>
              <div class="nested-table">
                <table>
                  <tr>
                    <th>Style errors (PEP8 spacing, indentation, etc.) (E)</th>
                    <td>
                      {{ semantic_metrics["flake8_error_breakdown"]["E"] }}
                    </td>
                  </tr>
                  <tr>
                    <th>
                      Logical errors (undefined vars, unused imports, etc.) (F)
                    </th>
                    <td>
                      {{ semantic_metrics["flake8_error_breakdown"]["F"] }}
                    </td>
                  </tr>
                  <tr>
                    <th>Warnings (whitespace, etc.) (W)</th>
                    <td>
                      {{ semantic_metrics["flake8_error_breakdown"]["W"] }}
                    </td>
                  </tr>
                  <tr>
                    <th>McCabe complexity issues (C)</th>
                    <td>
                      {{ semantic_metrics["flake8_error_breakdown"]["C"] }}
                    </td>
                  </tr>
                  <tr>
                    <th>Naming conventions (N)</th>
                    <td>
                      {{ semantic_metrics["flake8_error_breakdown"]["N"] }}
                    </td>
                  </tr>
                </table>
              </div>
            </td>
          </tr>
          <tr>
            <th>Mypy type-check errors</th>
            <td>{{ semantic_metrics["mypy_error_count"] }}</td>
          </tr>
          <tr>
            <th>Mypy error breakdown</th>
            <td>
              <div class="nested-table">
                <table>
                  <tr>
                    <th>Return type</th>
                    <td>
                      {{ semantic_metrics["mypy_error_breakdown"]["return_type"]
                      }}
                    </td>
                  </tr>
                  <tr>
                    <th>Argument type</th>
                    <td>
                      {{
                      semantic_metrics["mypy_error_breakdown"]["argument_type"]
                      }}
                    </td>
                  </tr>
                  <tr>
                    <th>Missing return</th>
                    <td>
                      {{
                      semantic_metrics["mypy_error_breakdown"]["missing_return"]
                      }}
                    </td>
                  </tr>
                  <tr>
                    <th>Attribute</th>
                    <td>
                      {{
                      semantic_metrics["mypy_error_breakdown"]["attribute_error"]
                      }}
                    </td>
                  </tr>
                  <tr>
                    <th>Annotation</th>
                    <td>
                      {{
                      semantic_metrics["mypy_error_breakdown"]["annotation_issue"]
                      }}
                    </td>
                  </tr>
                  <tr>
                    <th>Other</th>
                    <td>
                      {{ semantic_metrics["mypy_error_breakdown"]["other"] }}
                    </td>
                  </tr>
                </table>
              </div>
            </td>
          </tr>
          <tr>
            <th>Semantic quality score (0â€“100)</th>
            <td>{{ semantic_metrics["semantic_quality_score"] }}</td>
          </tr>
        </table>
      </div>

      <h2>Execution-Based Metrics</h2>
      <div class="metrics">
        <table>
          <tr>
            <th>Execution success</th>
            <td>{{ execution_metrics["execution_success"] }}</td>
          </tr>
          <tr>
            <th>Execution time (s)</th>
            <td>
              {{ "%.3f"|format(execution_metrics["execution_time_sec"]) }}
            </td>
          </tr>
          <tr>
            <th>Exception type</th>
            <td>{{ execution_metrics["exception_type"] }}</td>
          </tr>
          <tr>
            <th>Exception message</th>
            <td>{{ execution_metrics["exception_message"] }}</td>
          </tr>
          <tr>
            <th>Runtime output (preview)</th>
            <td>
              <div class="runtime-output">
                <pre>{{ execution_metrics["runtime_output"] }}</pre>
              </div>
            </td>
          </tr>
        </table>
      </div>
      
      <h2>Total Credibility (0-100%)</h2>
      <p><b>Credibility:</b> {{ "%.2f"|format(credibility) }}%</p>

      <h2>Visualizations</h2>
      <div class="visualizations">
        <h3>Basic Confidence Metrics</h3>
        <img src="1_logprob_trend.png" alt="Log Probability Trend" />
        <img src="2_probability_distribution.png" alt="Probability Distribution" />
        <img src="3_cumulative_logprob.png" alt="Cumulative Log Probability" />
        
        <h3>Advanced Analysis</h3>
        <img src="4_smoothed_confidence.png" alt="Smoothed Confidence Trend" />
        <img src="5_uncertainty_heatmap.png" alt="Uncertainty Detection" />
        <img src="6_rolling_perplexity.png" alt="Rolling Perplexity" />
        
        <h3>Segmented Analysis</h3>
        <img src="7_confidence_by_segment.png" alt="Confidence by Segment" />
        <img src="8_confidence_by_token_type.png" alt="Confidence by Token Type" />
        <img src="9_confidence_volatility.png" alt="Confidence Volatility" />
        <img src="10_top_uncertain_tokens.png" alt="Top Uncertain Tokens" />
      </div>
    </div>
  </body>
</html>
